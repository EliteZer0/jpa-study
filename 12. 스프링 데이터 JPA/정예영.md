## μ¤ν”„λ§ λ°μ΄ν„° JPAλ€

- μ¤ν”„λ§ ν”„λ μ„μ›ν¬μ—μ„ JPAλ¥Ό νΈλ¦¬ν•κ² μ‚¬μ©ν•  μ μλ„λ΅ μ§€μ›ν•λ” μ¶”μƒν™” ν”„λ μ„μ›ν¬

- λ°λ³µμ μ΄κ³  μ§€λ£¨ν• DAO/Repository μ½”λ“ μ‘μ„±μ„ μ¤„μ—¬μ£Όλ©°, μ„ μ–Έν• λ°©μ‹μΌλ΅ DB μ ‘κ·Όμ΄ κ°€λ¥
### κΈ°μ΅΄ DAO λ°©μ‹ vs μ¤ν”„λ§ λ°μ΄ν„° JPA λ°©μ‹ λΉ„κµ
	
#### μ „ν†µμ μΈ DAO λ°©μ‹ (JDBC / JPA μ§μ ‘ μ‚¬μ©)
	
```java
public class MemberDao {
    @PersistenceContext
    private EntityManager em;

    public Member findById(Long id) {
        return em.find(Member.class, id);
    }

    public void save(Member member) {
        if (member.getId() == null) {
            em.persist(member);
        } else {
            em.merge(member);
        }
    }

    public List<Member> findByUsername(String username) {
        return em.createQuery("select m from Member m where m.username = :username", Member.class)
                 .setParameter("username", username)
                 .getResultList();
    }
}
```
	
-  **λ¬Έμ μ **: λ¨λ“  CRUD κΈ°λ¥μ— λ€ν•΄ λ©”μ„λ“λ¥Ό μΌμΌμ΄ μ‘μ„±ν•΄μ•Ό ν•κ³ , JPQLμ΄λ‚ μ΅°κ±΄μ„ μ§μ ‘ μ„¤μ •
-  **λΉ„ν¨μ¨**: μ½”λ“ μ¤‘λ³µ + μ μ§€λ³΄μ μ–΄λ ¤μ›€
	    
#### μ¤ν”„λ§ λ°μ΄ν„° JPA λ°©μ‹

```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    List<Member> findByUsername(String username);
}
```

- **μ¥μ **:
    - `JpaRepository`λ¥Ό μƒμ†λ°›λ” κ²ƒλ§μΌλ΅ `save()`, `findById()`, `delete()` λ“± λ¨λ“  CRUD κΈ°λ¥μ΄ μλ™ μ κ³µ
    - `findByUsername()`μ²λΌ λ©”μ„λ“ μ΄λ¦„λ§μΌλ΅ JPQL μ—†μ΄ μ΅°ν κΈ°λ¥ κµ¬ν„ κ°€λ¥.
    - μ‹¤μ λ΅λ” κµ¬ν„ ν΄λμ¤κ°€ μ—†μ§€λ§, μ¤ν”„λ§μ΄ **μ‹¤ν–‰ μ‹μ μ— λ™μ μΌλ΅ ν”„λ΅μ‹ κ°μ²΄λ¥Ό μƒμ„±ν•μ—¬ μ£Όμ…**

#### "μ„ μ–Έν• λ°©μ‹"μ΄λ€?

λ¬΄μ—‡μ„ ν•κ³  μ‹¶μ€μ§€λ§ μ„ μ–Έν•λ©΄ μ–΄λ–»κ² ν• μ§€λ” ν”„λ μ„μ›ν¬κ°€ μ•μ•„μ„ μ²λ¦¬ν•λ” λ°©μ‹

- μ „ν†µ λ°©μ‹μ€ "μ–΄λ–»κ²"μ— μ§‘μ¤‘ β†’ SQL, νΈλμ­μ… μ§μ ‘ μ μ–΄
- μ„ μ–Έν• λ°©μ‹μ€ "λ¬΄μ—‡μ„"μ— μ§‘μ¤‘ β†’ `findByName()`, `@Transactional` λ“±μΌλ΅ μλ„λ¥Ό μ„ μ–Έ
    

#### μ„ μ–Έν• μμ‹

```java
@Transactional
public void updateMemberName(Long id, String name) {
    Member member = memberRepository.findById(id).orElseThrow();
    member.setName(name);
}
```

- `@Transactional`: μ„ μ–Έν• νΈλμ­μ… κ΄€λ¦¬
- `findById()`: μ΄λ¦„λ§μΌλ΅ μλ™ SQL μ‹¤ν–‰

- `JpaRepository` μΈν„°νμ΄μ¤λ§ μƒμ†λ°›μ•„ μ‘μ„±ν•λ©΄, **κµ¬ν„ μ—†μ΄ λ™μ‘ν•λ” λ¦¬ν¬μ§€ν† λ¦¬**κ°€ μλ™ μƒμ„±
### κµ¬μ΅°μ™€ κΈ°λ³Έ κµ¬μ„± μ”μ†

- μ£Όμ” μƒμ† κµ¬μ΅°: `JpaRepository` β† `PagingAndSortingRepository` β† `CrudRepository`
- λ€ν‘μ μΈ μΈν„°νμ΄μ¤:
    - `JpaRepository<T, ID>`: CRUD + νμ΄μ§• + μ •λ ¬ λ“± μ κ³µ
    - `JpaSpecificationExecutor<T>`: μ΅°κ±΄ κΈ°λ° μΏΌλ¦¬ μ‘μ„±μ— μ μ©
        
## μΏΌλ¦¬ λ©”μ†λ“μ 3κ°€μ§€ μ‘μ„± λ°©μ‹

1. **λ©”μ†λ“ μ΄λ¦„μΌλ΅ μΏΌλ¦¬ μƒμ„±**
    
    - μ: `findByEmailAndName(String email, String name)`
    - λ©”μ†λ“ μ΄λ¦„λ§μΌλ΅ JPQL μΏΌλ¦¬κ°€ μƒμ„±
        
2. **JPA Named Query νΈμ¶**
    
    - `@NamedQuery` μ–΄λ…Έν…μ΄μ… μ‚¬μ©
    - λ„λ©”μΈ ν΄λμ¤μ— μ •μλ μ΄λ¦„ κΈ°λ° μΏΌλ¦¬ μ‹¤ν–‰
	
**NamedQuery μ •μ**

```java
@Entity
@NamedQuery(
    name = "Member.findByUsername",
    query = "select m from Member m where m.username = :username")
public class Member {
    ...
}
```

**NamedQuery νΈμ¶**

```java
public interface MemberRepository extends JpaRepository<Member, Long> {

    List<Member> findByUsername(@Param("username") String username);
}
```


3. **@Query μ–΄λ…Έν…μ΄μ… μ‚¬μ©**
    
    - JPQL λλ” λ„¤μ΄ν‹°λΈ μΏΌλ¦¬ μ§μ ‘ μ‘μ„± κ°€λ¥
    - μ„μΉ κΈ°λ° `?1` λλ” μ΄λ¦„ κΈ°λ° `:username` λ°”μΈλ”© μ§€μ›
        
    ```java
    @Query("select m from Member m where m.username = :username")
    List<Member> findByUsername(@Param("username") String username);
    ```

> "JPQLμ€ μ„μΉ κΈ°λ° νλΌλ―Έν„°λ¥Ό 1λ¶€ν„° μ‹μ‘ν•μ§€λ§ λ„¤μ΄ν‹°λΈ SQLμ€ 0λ¶€ν„° μ‹μ‘ν•λ‹¤."

#### JPQL (JPA Query Language)

- μ„μΉ κΈ°λ° νλΌλ―Έν„°: **`?1`, `?2`... μ²λΌ 1λ¶€ν„° μ‹μ‘**
- μ:
    
    ```java
    @Query("select m from Member m where m.username = ?1")
    ```
    
#### λ„¤μ΄ν‹°λΈ SQL

- Hibernate + Spring Data JPA κΈ°μ¤€μ—μ„λ„ **`?1`, `?2`...μ²λΌ 1λ¶€ν„° μ‹μ‘**ν•λ” μ„μΉ κΈ°λ° νλΌλ―Έν„° μ‚¬μ©μ΄ κ°€λ¥ν•©λ‹λ‹¤.
- ν•μ§€λ§ μμ™Έμ μΌλ΅, **μ±…μ μμ²λΌ `?0`λ„ μ‘λ™ν•  μ μλ” κ²½μ°κ°€ μ΅΄μ¬**ν•©λ‹λ‹¤.
- μ:
    
    ```java
    @Query(value = "SELECT * FROM MEMBER WHERE USERNAME = ?0", nativeQuery = true)
    ```
    

- Hibernateμ μΌλ¶€ λ²„μ „μ΄λ‚ λ‚΄λ¶€ κµ¬ν„μ—μ„λ” `?0`μ„ ν—μ©ν•κΈ°λ„ ν•μ§€λ§, **κ³µμ‹ λ¬Έμ„λ‚ Spring Data JPAμ—μ„ κ¶μ¥ν•λ” λ°©μ‹μ€ `?1`λ¶€ν„° μ‹μ‘ν•λ” κ²ƒ**. `?1`λ¶€ν„° μ‚¬μ©ν•λ” κ²ƒμ΄ λ…ν™•ν•κ³  μ•μ „
    
#### μ •μ„μ μΈ κ¶μ¥ λ°©μ‹

- **JPQL & λ„¤μ΄ν‹°λΈ SQL λ¨λ‘ `?1`, `?2`, ... μ‚¬μ©**
    
- λλ” μ΄λ¦„ κΈ°λ° λ°”μΈλ”© μ‚¬μ©:
    
    ```java
    @Query("SELECT m FROM Member m WHERE m.username = :username")
    Member findByUsername(@Param("username") String username);
    ```
    
> μ™ μ΄λ° λ‚΄μ©μ΄ μ΅΄μ¬ν• κΉ?

μ‹¤μ λ΅ **κ³Όκ±°**μ—λ” μΌλ¶€ λ²„μ „μ **Spring Data JPA λλ” Hibernate**μ—μ„ **λ„¤μ΄ν‹°λΈ μΏΌλ¦¬μ—μ„ μ„μΉ κΈ°λ° νλΌλ―Έν„°λ¥Ό `?0`λ¶€ν„° μ‹μ‘ν•λ„λ΅ ν—μ©ν–λ μ‚¬λ΅€**κ°€ μλ‹¤.

### Spring Data JPA < 2.0 / Hibernate 5.x μ΄μ „

- μΌλ¶€ λ„¤μ΄ν‹°λΈ μΏΌλ¦¬μ—μ„ `?0`, `?1` λ¨λ‘ μ‘λ™ν•λ” **λΉ„ν‘μ¤€μ  μ²λ¦¬**κ°€ μμ—λ‹¤.
- λ‹Ήμ‹ λ‚΄λ¶€μ μΌλ΅λ” **Spring Dataκ°€ λ¦¬ν¬μ§€ν† λ¦¬ λ©”μ†λ“μ νλΌλ―Έν„° μΈλ±μ¤λ¥Ό κ·Έλ€λ΅ μ‚¬μ©ν•λ” λ°©μ‹**μ΄ μμ—κ³ ,  μ΄λ•λ” **0λ¶€ν„° μ‹μ‘ν•λ” κ²½μ°λ„ μ΅΄μ¬**ν–λ‹¤.
- κ·Έ λ•λ¬Έμ— μΌλ¶€ μ±…, λΈ”λ΅κ·Έ, μ‹¤λ¬΄ μ½”λ“μ—μ„λ„ `?0`μ„ μ“°λ” μκ°€ λ‚¨μ•„ μλ‹¤.

### ν•μ§€λ§

- **JPQLμ€ JPA ν‘μ¤€ λ…μ„Έμ—μ„ `?1`λ¶€ν„° μ‹μ‘**ν•λ„λ΅ λ…μ‹λμ–΄ μλ‹¤.
- λ„¤μ΄ν‹°λΈ μΏΌλ¦¬λ” JPAκ°€ μ•„λ‹ DBμ— μ§μ ‘ μ „λ‹¬λμ§€λ§, Spring Data JPAλ” μ΄λ¥Ό κ°μ‹Έλ©΄μ„ **JPQLκ³Ό λ™μΌν• ν¨ν„΄ (`?1`)μΌλ΅ ν†µμΌ**ν•΄ μ™”λ‹¤.
- λ‹¤λ§ Hibernateλ” λ‚΄λ¶€μ μΌλ΅ JDBC λ°”μΈλ”©μ„ μ‚¬μ©ν•λ©° μ΄ κ³Όμ •μ—μ„ μ•½κ°„μ κ΄€μ©μ μΈ μ²λ¦¬λ΅ `?0`μ„ λ°›μ•„λ“¤μ΄κΈ°λ„ ν–λ‹¤.

### ν„μ¬ κΈ°μ¤€ (2024~2025)

- Spring Data JPA 2.0 μ΄μƒ, Hibernate 5.2+ μ΄ν›„:
    - **JPQLκ³Ό λ„¤μ΄ν‹°λΈ μΏΌλ¦¬ λ¨λ‘ `?1`, `?2`, ... μ‚¬μ©μ΄ ν‘μ¤€**
    - `?0`μ€ **κ¶μ¥λμ§€ μ•μΌλ©°, μΌλ¶€ ν™κ²½μ—μ„λ§ λ™μ‘**


## μ¶”κ°€ κΈ°λ¥

### λ²ν¬μ„± μΏΌλ¦¬

- `@Modifying` μ–΄λ…Έν…μ΄μ… ν•„μ”
- λ²ν¬μ„± μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•κ³  λ‚μ„ μμ†μ„± μ»¨ν…μ¤νΈλ¥Ό μ΄κΈ°ν™”ν•κ³  μ‹¶μΌλ©΄ `clearAutomatically` μµμ…μ„ trueλ΅ μ„¤μ •ν•λ©΄ λλ‹¤.

```java
@Modifying(clearAutomatically = true)
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

### νμ΄μ§• & μ •λ ¬

- `Pageable`, `Sort` κ°μ²΄λ¥Ό ν†µν•΄ μ§€μ›
    

```java
//count μΏΌλ¦¬ μ‚¬μ©
Page<Member> findByUsername(String name, Pageable pageable);

//count μΏΌλ¦¬ μ‚¬μ© μ•ν•¨
List<Member> findByUsername(String name, Pageable pageable); 
List<Member> findByUsername(String name, Sort sort);
```

## μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κµ¬ν„

- λ³µμ΅ν• μΏΌλ¦¬λ” μ‚¬μ©μ μ •μ κµ¬ν„ ν΄λμ¤λ¥Ό ν†µν•΄ ν•΄κ²°
- κµ¬ν„ ν΄λμ¤ μ΄λ¦„μ€ λ°λ“μ‹ `Impl`λ΅ λλ‚μ•Ό ν•¨

```java
//μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤
public interface MemberRepositoryCustom {

    public List<Member> findMemberCustom();
}

//μ‚¬μ©μ μ •μ κµ¬ν„ ν΄λμ¤
public class MemberRepositoryImpl implements MemberRepositoryCustom {

    @Override
    public List<Member> findMemberCustom() {
        ...
    }
}

//μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ μƒμ†
public interface MemberRepository extends JpaRepository<Member, Long>, 
    MemberRepositoryCustom {

}
```

## μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μ‚¬μ©ν•λ” κµ¬ν„μ²΄

- μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μ κ³µν•λ” κ³µν†µ μΈν„°νμ΄μ¤λ” `SimpleJpaRepository`
- μ΄ ν΄λμ¤κ°€ `JpaRepository`, `JpaSpecificationExecutor`λ¥Ό κµ¬ν„ν•¨
- `@Repository`, `@Transactional` μ–΄λ…Έν…μ΄μ…μΌλ΅ μμ™Έ λ° νΈλμ­μ…μ„ μ²λ¦¬

```java
@Repository
@Transactional(readOnly = true)
public class SimpleJpaRepository<T, Id extends Serializable> implements
    JpaRepository<T, ID>, 
				JpaSpecificationExecutor<T> {

    @Transactional
    public <S extends T> S save(S entity) {
        if (entityInformation.isnew(entity)) {
            em.persist(entity);
            return entity;
        } else {
            return em.merge(entity);
        }    
    }    
    ...
}
```

- @Repository μ μ©
    - JPA μμ™Έλ¥Ό μ¤ν”„λ§μ΄ μ¶”μƒν™”ν• μμ™Έλ΅ λ³€ν™ν•λ‹¤.
- @Transaction νΈλμ­μ… μ μ©
    - JPAμ λ¨λ“  λ³€κ²½μ€ νΈλμ­μ… μ•μ—μ„ μ΄λ£¨μ–΄μ Έμ•Ό ν•λ‹¤.
- `save()` λ©”μ†λ“
    - μ €μ¥ν•  μ—”ν‹°ν‹°κ°€ μƒλ΅μ΄ μ—”ν‹°ν‹°λ©΄ μ €μ¥ν•κ³ , μ΄λ―Έ μλ” μ—”ν‹°ν‹°λ©΄ λ³‘ν•©(merge)ν•λ‹¤.
    - μƒλ΅μ΄ μ—”ν‹°ν‹°λ¥Ό νλ‹¨ν•λ” κΈ°λ³Έ μ „λµμ€ μ—”ν‹°ν‹°μ μ‹λ³„μλ΅ νλ‹¨ν•λ‹¤. μ‹λ³„μκ°€ κ°μ²΄μΌ λ• null, μλ°” κΈ°λ³Έ νƒ€μ…μΌ λ• μ«μ 0 κ°’μ΄λ©΄ μƒλ΅μ΄ μ—”ν‹°ν‹°λ΅ νλ‹¨ν•λ‹¤.

## λ…μ„Έ(Specification) API μ •λ¦¬

### λ…μ„Έ(Specification)λ€?

- **λ³µμ΅ν• μ΅°κ±΄ κΈ°λ°μ μΏΌλ¦¬λ¥Ό κ°μ²΄ν™”ν•κ³  μ΅°λ¦½μ‹μΌλ΅ μ‘μ„±ν•  μ μλ„λ΅ λ„μ™€μ£Όλ” JPA κΈ°λ¥**
- `JpaSpecificationExecutor<T>` μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ μ§€μ›λλ©°, λ‹¤μ–‘ν• μ΅°κ±΄μ„ `and()`, `or()`λ΅ μ΅°ν•©ν•μ—¬ **λ™μ  μΏΌλ¦¬**λ¥Ό λ§λ“¤ μ μλ‹¤.
    

```java
Specification<Order> spec = where(memberName("μƒμ°")).and(isOrderStatus());
List<Order> results = orderRepository.findAll(spec);
```

- κ° μ΅°κ±΄μ€ `Specification<T>` μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν• κ°μ²΄λ΅ μ •μ

### μ΅°κ±΄ μ •μ μμ‹

```java
public static Specification<Order> memberName(String name) {
    return (root, query, cb) -> {
        if (name == null || name.isEmpty()) return null;
        return cb.equal(root.join("member").get("name"), name);
    };
}

public static Specification<Order> isOrderStatus() {
    return (root, query, cb) -> cb.equal(root.get("status"), OrderStatus.ORDER);
}
```

- μ΄λ° μ‹μΌλ΅ κ° μ΅°κ±΄μ„ λ©”μ„λ“λ΅ λ¶„λ¦¬ν•΄ μ¬μ‚¬μ©μ„±κ³Ό κ°€λ…μ„±μ„ λ†’μΌ μ μλ‹¤.


### λ…μ„Έ APIμ μ„Έλ¶„ν™” (Spring Data JPA μµμ‹  κΈ°λ¥)

> β… Spring Data JPA 3.2+μ—μ„λ” κΈ°μ΅΄μ `Specification<T>`μ„ λ©μ μ— λ”°λΌ λ‹¤μμ²λΌ **λ…ν™•ν λ¶„λ¦¬**

|μ ν•|μ„¤λ…|
|---|---|
|`PredicateSpecification<T>`|μ΅°κ±΄ κΈ°λ° **μ΅°νμ©** λ…μ„Έ|
|`UpdateSpecification<T>`|μ΅°κ±΄ + ν•„λ“ λ³€κ²½ κ°’μ„ μ§€μ •ν•λ” **μμ •μ©** λ…μ„Έ|
|`DeleteSpecification<T>`|μ΅°κ±΄μ„ μ§€μ •ν•λ” **μ‚­μ μ©** λ…μ„Έ|


```java
PredicateSpecification<Member> spec = (root, query, cb) ->
    cb.equal(root.get("age"), 30);

// μμ • λ…μ„Έ μμ‹ (UpdateSpecification)
UpdateSpecification<Member> updateSpec = UpdateSpecification.of(spec)
    .set("status", MemberStatus.INACTIVE);
```

- μ΄λ¥Ό ν†µν•΄ μ΅°νλΏ μ•„λ‹λΌ **μ΅°κ±΄ κΈ°λ° μΌκ΄„ μ—…λ°μ΄νΈ / μ‚­μ  μ‘μ—…**λ„ λ…μ„Έ κΈ°λ°μΌλ΅ μ²λ¦¬ν•  μ μλ‹¤.
    
- μ½”λ“μ **μ—­ν• μ΄ λ…ν™•ν•΄μ§€κ³ **, **λ©”μ„λ“ μ¬μ‚¬μ©μ„±** ν–¥μƒ

### λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°

- HTTP νλΌλ―Έν„°λ¥Ό μ—”ν‹°ν‹° IDλ΅ λ³€ν™ν•μ—¬ μλ™ μ£Όμ…

```java
public String memberUpdateForm(@RequestParam("id") Member member, Model model) { ... }
```

### νμ΄μ§• λ° μ •λ ¬ μλ™ μ²λ¦¬

- URL: `/members?page=0&size=20&sort=name,desc`
    
- μ»¨νΈλ΅¤λ¬ νλΌλ―Έν„°μ— `Pageable pageable` μ„ μ–Έν•λ©΄ μλ™ μ²λ¦¬λ¨
    
## π” QueryDSL ν†µν•© μ§€μ›

- `QuerydslPredicateExecutor`, `QuerydslRepositorySupport`μ„ ν†µν•΄ QueryDSL ν†µν•© μ‚¬μ© κ°€λ¥
    


