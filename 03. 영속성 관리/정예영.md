# 03. 영속성 관리

## 3-1 엔티티 매니저 팩토리와 엔티티 매니저

**엔티티 매니저 팩토리**는 엔티티 매니저를 생성하는 공장이다.  
이 공장을 만드는 비용이 크기 때문에 애플리케이션 전체에서 하나만 만들어 공유한다.  
반면, **엔티티 매니저**는 생성 비용이 거의 들지 않는다.  
엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하지만, 엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 절대 공유하면 안 된다.

---

## 3-2 영속성 컨텍스트란?

**영속성 컨텍스트**는 JPA를 이해하는 데 가장 중요한 개념이다.  
영속성 컨텍스트는 엔티티를 영구 저장하는 환경이다.  
엔티티 매니저로 엔티티를 저장하거나 조회하면 영속성 컨텍스트에 엔티티가 보관되고 관리된다.  

- `persist()` 메소드는 엔티티를 영속성 컨텍스트에 저장한다.
- 여러 엔티티 매니저가 같은 영속성 컨텍스트에 접근할 수도 있다(자세한 내용은 11장에서 다룬다).

---

## 3-3 엔티티의 생명주기

엔티티에는 4가지 상태가 있다:
- **비영속(new/transient)**: 영속성 컨텍스트와 전혀 관계가 없는 상태.
- **영속(managed)**: 영속성 컨텍스트에 저장된 상태.
- **준영속(detached)**: 영속성 컨텍스트에서 분리된 상태.
- **삭제(removed)**: 삭제된 상태.

### 비영속
엔티티 객체를 생성했을 때, 아직 저장하지 않아 영속성 컨텍스트와 데이터베이스와 관련이 없는 상태를 비영속 상태라 한다.

### 영속
엔티티 매니저를 통해 엔티티를 영속성 컨텍스트에 저장하면 영속 상태가 된다.  
이는 영속성 컨텍스트에 의해 관리되는 상태를 의미한다.

### 준영속
영속성 컨텍스트가 관리하던 엔티티가 더 이상 관리되지 않으면 준영속 상태가 된다.  
준영속 상태로 전환하는 방법은 다음과 같다:
1. `em.detach(entity)`: 특정 엔터티만 준영속 상태로 전환한다.
2. `em.clear()`: 영속성 컨텍스트를 완전히 초기화한다.
3. `em.close()`: 영속성 컨텍스트를 종료한다.

### 삭제
`em.remove()` 메소드를 호출하여 엔터티를 삭제할 수 있다.  
삭제된 엔터티는 데이터베이스에서도 제거된다.

---

## 3-4 영속성 컨텍스트의 특징

### 1차 캐시
영속성 컨텍스트는 내부에 캐시(1차 캐시)를 가지고 있다.  
1차 캐시는 Map 구조로, 키는 식별자(@Id) 값이고 값은 엔터티 인스턴스다.

### 동일성 보장
JPA는 동일성을 보장한다:
- **동일성(identity)**: 실제 인스턴스가 같아 `==` 비교 시 true.
- **동등성(equality)**: 값이 같아 `equals()` 비교 시 true.

### 트랜잭션을 지원하는 쓰기 지연
트랜잭션을 커밋하기 직전까지 INSERT, UPDATE, DELETE SQL을 모아두고 한 번에 실행한다.

### 변경 감지(Dirty Checking)
JPA는 스냅샷을 통해 변경 사항을 감지하고 필요한 SQL을 생성하여 데이터베이스에 반영한다.

### 지연 로딩(Lazy Loading)
데이터를 실제 사용할 때만 로딩한다.

---

## 3-5 플러시

플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영하는 작업이다.  
플러시는 다음 세 가지 방법으로 발생한다:
1. `em.flush()` 메소드를 직접 호출.
2. 트랜잭션 커밋 시 자동 호출.
3. JPQL 쿼리 실행 시 자동 호출.

**플러시 모드 옵션**:
- `FlushModeType.AUTO`: 기본값으로 커밋이나 쿼리 실행 시 플러시.
- `FlushModeType.COMMIT`: 커밋할 때만 플러시.

플러시는 변경 내용을 데이터베이스에 동기화하지만, 영속성 컨텍스트 자체를 지우지는 않는다.

---

## 3-6 준영속

준영속 상태는 영속 상태의 엔터티가 더 이상 영속성 컨텍스트에서 관리되지 않는 상태다.  
준영속 상태로 전환하는 방법은 다음과 같다:
1. `em.detach(entity)`: 특정 엔터티만 준영속 상태로 전환.
2. `em.clear()`: 모든 엔터티를 준영속 상태로 전환.
3. `em.close()`: 영속성 컨텍스트 종료로 모든 엔터티가 준영속 상태로 전환.

### 병합(merge)
`merge()` 메소드는 준영속 또는 비영속 상태의 엔터티를 다시 영속 상태로 만든다:
1. 식별자 값으로 1차 캐시에서 조회.
2. 없으면 데이터베이스에서 조회 후 1차 캐시에 저장.
3. 조회한 값을 기준으로 병합 후 새로운 영속 상태의 엔터티 반환.

---

## 3-7 정리

- **엔터티 매니저 팩토리**는 애플리케이션 전체에서 공유하며, **엔터티 매니저**는 각 스레드마다 독립적으로 사용해야 한다.
- **영속성 컨텍스트**는 애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 역할을 한다.
- 주요 기능: 1차 캐시, 동일성 보장, 트랜잭션 지원 쓰기 지연, 변경 감지, 지연 로딩.
- 플러시는 변경 내용을 데이터베이스에 반영하지만, 영속성 컨텍스트 자체는 유지된다.
- 준영속 상태에서는 JPA의 기능을 사용할 수 없으며, 필요 시 병합(merge)을 통해 다시 영속 상태로 전환할 수 있다.
