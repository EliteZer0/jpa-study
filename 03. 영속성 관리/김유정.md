# 03 영속성 관리
    JPA 기능 1. 엔티티

    JPA 기능 2. 설계 (테이블 매핑)

    JPA 기능 3. 사용

### 3.1 엔티티 매니저 팩토리와 엔티티 매니저
엔티티 매니저 팩토리 생성 코드 입력 시, persistence.xml 정보를 바탕으로 생성
```
// 공장만들기 -> 고비용
// 스레드 간 공유 안전
EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");

// 공장에서 엔티티 매니저 생성 -> 저비용
// 스레드 간 공유 동시성 문제 발생
EntityManager em = emf.createEntityManager();
```

엔티티 매니저 팩토리 -> 엔티티 매니저 -> 데이터베이스 커넥션(트랜잭션 시작 시 획득) -> 데이터베이스

### 3.2 영속성 컨텍스트란?
persistence context : 엔티티를 영구 저장하는 환경
엔티티 메니저를 생성할 때 1개 생성되고 논리적 개념에 가깝다.

### 3.3 엔티티의 생명주기
1. 비영속(new/transient) : 객체 생성만 되고, 영속성 컨텍스트와 전혀 관계가 없는 상태
2. 영속(managed) : 영속성 컨텍스트에 저장된 상태
3. 준영속(detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태
4. 삭제(removed) : 삭제된 상태

### 3.4 영속성 컨텍스트의 특징
1. 영속 상태는 식별자 값이 반드시 있어야 한다.
2. JPA는 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터베이스에 반영한다. (플러시 flush)
3. 장점 : 1차 캐시, 동일성 보장, 트랜잭션을 지원하는 쓰기 지연, 변경 감지, 지연 로딩

- ```em.find()```를 호출하면 1차 캐시에서 식별자 값으로 엔티티 탐색
- 있다면 메모리에 있는 1차캐시에서 엔티티 조회
- 없다면 DB 조회해서 엔티티 생성하여 1차 캐시에 저장 후 영속 상태의 엔티티 반환

- 쓰기 지연 : 엔티티 매니저는 트랜잭선 커밋 전까지 내부 쿼리 저장소에 INSERT SQL 저장

- 변경 감지 : 엔티티 변경사항을 데이터베이스에 자동 반영

### 3.5 플러시
영속성 컨텍스트의 변경 내용을 데이터베이스에 반영한다.
1. 변경감지가 동작해서 모든 엔티티를 스냅샷과 비교해서 변경 사항 탐색
2. 수정된 엔티티는 쓰기 지연 SQL 저장소에 등록
3. 쿼리 전송

### 3.6 준영속
영속성 컨텍스트가 관리하는 영속 상태의 엔티티가 영속성 컨텍스트에서 분리된 것을 준영속 상태라고 한다.
따라서 준영속 상태의 엔티티는 영속성 컨텍스트가 제공하는 기능을 사용할 수 없다.
```
1. em.detach(entity) : 특정 엔티티만 준영속 상태로 전환한다.
2. em.clear() : 영속성 컨텍스트를 완전히 초기화한다.
3. em.close(): 영속성 컨텍스트를 종료한다.
```
